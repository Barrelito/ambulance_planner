<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Ambulansplanering</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        .unit-row { border-bottom: 1px solid #eee; padding: 10px 0; }
        .sits-badge { background-color: #ffc107; color: #000; font-weight: bold; font-size: 0.8em; padding: 2px 6px; border-radius: 4px; }
        .c1-badge { background-color: #0d6efd; color: #fff; font-weight: bold; font-size: 0.8em; padding: 2px 6px; border-radius: 4px; margin-left: 2px; }
        .shift-box { background-color: #f8f9fa; border: 1px dashed #ccc; padding: 8px; text-align: center; border-radius: 5px; cursor: pointer; transition: 0.2s; min-height: 50px; position: relative;}
        .shift-box:hover { background-color: #e2e6ea; border-color: #adb5bd; }
        .blankpass-box { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; cursor: pointer; transition: 0.2s; text-align: center; height: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .blankpass-box:hover { background-color: #f3e5f5; border-color: #6f42c1; transform: translateY(-2px); }
        .blankpass-active { background-color: #e1bee7; border-color: #8e24aa; }
        .shift-warning { background-color: #fff3cd !important; border: 2px solid #ffc107 !important; }
        .station-header { cursor: pointer; transition: background-color 0.2s; }
        .station-header:hover { opacity: 0.9; }
        .bg-purple { background-color: #6f42c1 !important; }
        .status-dot { height: 15px; width: 15px; border-radius: 50%; display: inline-block; border: 2px solid white; }
        .dot-green { background-color: #28a745; }
        .dot-red { background-color: #dc3545; }
        .time-label { font-size: 0.7em; color: #6c757d; display: block; margin-bottom: 4px; border-bottom: 1px solid #e9ecef; }
        .shift-disabled { background-color: #e9ecef; border: 1px solid #dee2e6; cursor: default; opacity: 0.6; }
        .comment-icon { position: absolute; top: 2px; right: 5px; font-size: 1.2em; }
        .interest-icon { position: absolute; top: 2px; left: 5px; font-size: 1.0em; text-shadow: 0 0 3px yellow; }
        
        /* --- H√ÑR √ÑR FIXEN F√ñR DUBBLA LISTOR --- */
        /* Tvinga original-listan att vara helt osynlig n√§r Select2 tagit √∂ver */
        select.select2-hidden-accessible {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0,0,0,0) !important;
            white-space: nowrap !important;
            border: 0 !important;
            opacity: 0 !important;
        }
        
        /* Justering f√∂r Select2 utseende i modal */
        .select2-container { width: 100% !important; }
        .select2-container--bootstrap-5 .select2-selection { border-color: #dee2e6; }
    </style>
</head>
<body class="bg-light">

<select id="vacanciesData" style="display:none;">
    <option value="">-- V√§lj bil --</option>
    {% for v in vacant_spots %}
        <option value="{{ v.id }}|{{ v.period }}">{{ v.station }} - {{ v.name }} ({{ v.period }})</option>
    {% endfor %}
</select>

<div class="bg-white shadow-sm sticky-top mb-4 py-3">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="m-0 fw-bold">üöë VO NORD <span class="text-primary ms-2">{{ current_date }}</span></h2>
            <div class="d-flex gap-2">
                <a href="/my_view" class="btn btn-info btn-sm text-white">üì± Min Sida</a>
                <a href="/dashboard" class="btn btn-primary btn-sm">üìä Samordnare</a>
                <a href="/admin" class="btn btn-secondary btn-sm">üîß Teknisk Admin</a>
            </div>
        </div>
        <form action="/" method="GET" class="d-flex justify-content-between align-items-center bg-light p-2 rounded border">
            <a href="/" class="btn btn-success fw-bold me-3">üìÖ IDAG</a>
            <div class="d-flex align-items-center flex-grow-1 justify-content-center">
                <a href="/?date={{ prev_date }}" class="btn btn-outline-dark fw-bold">‚Äπ F√∂reg√•ende dag</a>
                <input type="date" name="date" class="form-control w-auto mx-2" value="{{ current_date }}" onchange="this.form.submit()">
                <a href="/?date={{ next_date }}" class="btn btn-outline-dark fw-bold">N√§sta dag ‚Ä∫</a>
            </div>
            <div style="width: 80px;"></div>
        </form>
    </div>
</div>

<div class="container pb-5">
    {% for station in stations %}
    
    {% set status = namespace(has_vacancies=false) %}
    {% for unit in station.units %}
        {% set s_dag = shift_map.get(unit.id, {}).get('Dag') %}
        {% if not s_dag or not s_dag.amb or not s_dag.vub %} {% set status.has_vacancies = true %} {% endif %}
        {% if 'BLANKPASS' not in station.name %}
            {% set s_natt = shift_map.get(unit.id, {}).get('Natt') %}
            {% if not s_natt or not s_natt.amb or not s_natt.vub %} {% set status.has_vacancies = true %} {% endif %}
        {% endif %}
    {% endfor %}

    {% set header_bg = 'bg-purple' if 'BLANKPASS' in station.name else 'bg-dark' %}

    <div class="card mb-3 shadow-sm" id="station-{{ station.id }}">
        <div class="card-header text-white station-header d-flex justify-content-between align-items-center {{ header_bg }}" 
             data-bs-toggle="collapse" data-bs-target="#collapse-{{ station.id }}">
            <div class="d-flex align-items-center gap-3">
                {% if 'BLANKPASS' not in station.name %}
                    {% if status.has_vacancies %} <span class="status-dot dot-red"></span> {% else %} <span class="status-dot dot-green"></span> {% endif %}
                {% endif %}
                <h5 class="m-0">{{ station.name }}</h5>
            </div>
            <small class="text-white">Visa/D√∂lj ‚ñº</small>
        </div>

        <div id="collapse-{{ station.id }}" class="collapse show station-collapse">
            <div class="card-body">
                {% if 'BLANKPASS' in station.name %}
                    <div class="row g-3">
                        {% for unit in station.units %}
                            {% set shift = shift_map.get(unit.id, {}).get('Dag') %}
                            {% set amb_val = shift.amb_id if shift and shift.amb_id else '' %}
                            {% set vub_val = shift.vub_id if shift and shift.vub_id else '' %}
                            {% set is_active = 'blankpass-active' if (shift and (shift.amb or shift.vub)) else '' %}
                            {% set person_id = amb_val if amb_val else vub_val %}
                            {% set person_name = shift.amb.name if shift.amb else (shift.vub.name if shift.vub else '') %}
                            {% set comment = shift.comment if shift and shift.comment else '' %}

                            <div class="col-md-3 col-6">
                                <div class="blankpass-box {{ is_active }}"
                                     onclick="openModal(this)"
                                     data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name }}" data-period="Dag"
                                     data-amb="{{ amb_val }}" data-vub="{{ vub_val }}" data-comment="{{ comment }}"
                                     data-requires-sits="False" data-requires-c1="False"
                                     data-person-id="{{ person_id }}" data-person-name="{{ person_name }}">
                                    
                                    {% if comment %} <span class="comment-icon" title="{{ comment }}">üí¨</span> {% endif %}
                                    <div class="fw-bold text-muted small mb-1">{{ unit.name }}</div>
                                    {% if shift and (shift.amb or shift.vub) %}
                                        <div class="fw-bold text-dark">{{ person_name }}</div>
                                    {% else %}
                                        <div class="text-muted small my-2">-- Ledig --</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="row fw-bold mb-2 text-muted uppercase text-center" style="font-size: 0.9em;">
                        <div class="col-md-2 text-start">ENHET</div><div class="col-md-3">DAG</div><div class="col-md-3">MELLAN</div><div class="col-md-3">NATT</div><div class="col-md-1"></div>
                    </div>
                    {% for unit in station.units %}
                    <div class="row unit-row align-items-center">
                        <div class="col-md-2">
                            <span class="fw-bold">{{ unit.name }}</span>
                            {% if unit.requires_sits %} <div class="sits-badge d-inline-block mt-1">SITS</div> {% endif %}
                            {% if unit.requires_c1 %} <div class="c1-badge d-inline-block mt-1">C1</div> {% endif %}
                            {% if unit.is_flex %} <span class="badge bg-success">FLEX</span> {% endif %}
                        </div>
                        {% for p in ['Dag', 'Mellan', 'Natt'] %}
                            <div class="col-md-3">
                                {% set shift = shift_map.get(unit.id, {}).get(p) %}
                                {% set t_tid = unit.day_time if p == 'Dag' else (unit.night_time if p == 'Natt' else unit.mid_time) %}
                                {% if t_tid %}
                                    {% set warning = false %}
                                    {% if unit.requires_sits and shift and ((shift.amb and not shift.amb.has_sits) or (shift.vub and not shift.vub.has_sits)) %} {% set warning = true %} {% endif %}
                                    {% if unit.requires_c1 and shift and shift.amb and not shift.amb.has_c1 %} {% set warning = true %} {% endif %}

                                    {% set amb_val = shift.amb_id if shift and shift.amb_id else '' %}
                                    {% set vub_val = shift.vub_id if shift and shift.vub_id else '' %}
                                    {% set comment = shift.comment if shift and shift.comment else '' %}
                                    {% set interests = interest_map.get(shift.id, '') if shift else '' %}
                                    {% set is_full = shift.amb and shift.vub if shift else false %}
                                    {% set show_star = true if (interests and not is_full) else false %}

                                    <div class="shift-box {{ 'shift-warning' if warning else '' }}" 
                                         onclick="openModal(this)"
                                         data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name }}" data-period="{{ p }}"
                                         data-amb="{{ amb_val }}" data-vub="{{ vub_val }}"
                                         data-comment="{{ comment }}"
                                         data-requires-sits="{{ unit.requires_sits }}"
                                         data-requires-c1="{{ unit.requires_c1 }}"
                                         data-interests="{{ interests }}">
                                         
                                         {% if comment %} <span class="comment-icon" title="{{ comment }}">üí¨</span> {% endif %}
                                         {% if show_star %} <span class="interest-icon">üåü</span> {% endif %}

                                         <span class="time-label">{{ t_tid }}</span>
                                        {% if shift and (shift.amb or shift.vub) %}
                                            <div class="fw-bold text-primary">{{ shift.amb.name if shift.amb else '-' }}</div>
                                            <div class="fw-bold text-success">{{ shift.vub.name if shift.vub else '-' }}</div>
                                            {% if warning %}<div class="text-dark fw-bold small mt-1">‚ö†Ô∏è SAKNAS/FEL</div>{% endif %}
                                        {% else %} <small class="text-muted">Vakant</small> {% endif %}
                                    </div>
                                {% else %}
                                    {% if p != 'Mellan' or unit.mid_time %}
                                        <div class="shift-box shift-disabled"><span class="time-label">-</span><small class="text-muted">Ej i drift</small></div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="text-center py-4 border-top mt-5"><a href="/logout" class="text-danger text-decoration-none small">Logga ut</a></div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/update_shift" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Bemanna <span id="modalUnitName"></span> (<span id="modalPeriod"></span>)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="date" value="{{ current_date }}">
                    <input type="hidden" name="unit_id" id="inputUnitId">
                    <input type="hidden" name="period" id="inputPeriod">
                    <input type="hidden" id="unitRequiresSits">
                    <input type="hidden" id="unitRequiresC1">

                    <div id="applicantSection" class="mb-3 d-none">
                        <label class="form-label fw-bold text-dark">üåü Intresseanm√§lningar</label>
                        <div class="list-group mb-2" id="applicantList"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-primary" id="labelAmb">AMB</label>
                        <select name="amb_id" id="selectAmb" style="width: 100%;">
                            <option value="" data-sits="False" data-c1="False" data-role="None">-- Ingen vald --</option>
                            {% for station_name, group in users|groupby('home_station') %}
                                <optgroup label="{{ station_name }}">
                                    {% for user in group %}
                                        {% set busy = busy_users.get(user.id, {}) %}
                                        {% set is_bp = false %}
                                        {% set b_info = "" %}
                                        {% if busy %}
                                            {% set b_dag = busy.get('Dag', '') %}
                                            {% set b_mid = busy.get('Mellan', '') %}
                                            {% set b_natt = busy.get('Natt', '') %}
                                            {% if 'Plats' in b_dag or 'Plats' in b_mid or 'Plats' in b_natt %}
                                                {% set is_bp = true %}
                                                {% set b_info = "(P√•: " ~ (b_dag or b_mid or b_natt) ~ ")" %}
                                            {% endif %}
                                        {% endif %}
                                        <option value="{{ user.id }}" 
                                                data-sits="{{ user.has_sits }}" 
                                                data-c1="{{ user.has_c1 }}" 
                                                data-role="{{ user.role }}"
                                                data-busy-dag="{{ busy.get('Dag', '') }}" 
                                                data-busy-mellan="{{ busy.get('Mellan', '') }}" 
                                                data-busy-natt="{{ busy.get('Natt', '') }}"
                                                class="{{ 'text-primary fw-bold' if is_bp else '' }}">
                                            {{ user.name }} ({{ user.role }}) {{ b_info }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3" id="vubContainer">
                        <label class="form-label fw-bold text-success">VUB</label>
                        <select name="vub_id" id="selectVub" style="width: 100%;">
                            <option value="" data-sits="False" data-c1="False" data-role="None">-- Ingen vald --</option>
                            {% for station_name, group in users|groupby('home_station') %}
                                <optgroup label="{{ station_name }}">
                                    {% for user in group %}
                                        {% set busy = busy_users.get(user.id, {}) %}
                                        {% set is_bp = false %}
                                        {% set b_info = "" %}
                                        {% if busy %}
                                            {% set b_dag = busy.get('Dag', '') %}
                                            {% set b_mid = busy.get('Mellan', '') %}
                                            {% set b_natt = busy.get('Natt', '') %}
                                            {% if 'Plats' in b_dag or 'Plats' in b_mid or 'Plats' in b_natt %}
                                                {% set is_bp = true %}
                                                {% set b_info = "(P√•: " ~ (b_dag or b_mid or b_natt) ~ ")" %}
                                            {% endif %}
                                        {% endif %}
                                        <option value="{{ user.id }}" 
                                                data-sits="{{ user.has_sits }}" 
                                                data-c1="{{ user.has_c1 }}" 
                                                data-role="{{ user.role }}"
                                                data-busy-dag="{{ busy.get('Dag', '') }}" 
                                                data-busy-mellan="{{ busy.get('Mellan', '') }}" 
                                                data-busy-natt="{{ busy.get('Natt', '') }}"
                                                class="{{ 'text-primary fw-bold' if is_bp else '' }}">
                                            {{ user.name }} ({{ user.role }}) {{ b_info }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3"><textarea name="comment" id="inputComment" class="form-control" rows="2" placeholder="Kommentar..."></textarea></div>

                    <div id="c1Warning" class="alert alert-warning d-none mt-2">üõë <strong>C1 SAKNAS:</strong> AMB m√•ste ha C1-k√∂rkort p√• denna bil!</div>
                    <div id="roleWarning" class="alert alert-info d-none mt-2">üí° <strong>OBS:</strong> Rollblandning (VUB p√• AMB-rad eller tv√§rtom).</div>
                    <div id="sitsWarning" class="alert alert-warning d-none mt-2">‚ö†Ô∏è <strong>SITS:</strong> Bilen kr√§ver SITS.</div>
                    <div id="doubleBookingWarning" class="alert alert-danger d-none mt-2">üõë <strong>KROCK:</strong> <span id="doubleBookingText"></span></div>
                    <div id="moveInfo" class="alert alert-success d-none mt-2">‚ôªÔ∏è <strong>Flyttas:</strong> <span id="moveInfoText"></span> fr√•n resursplats.</div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button><button type="submit" class="btn btn-primary">Spara</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="moveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form action="/move_staff" method="POST"><div class="modal-header bg-success text-white"><h5 class="modal-title">‚ôªÔ∏è Flytta Resurs</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" name="date" value="{{ current_date }}"><input type="hidden" name="person_id" id="movePersonId"><h5 class="text-center mb-4">Vad vill du g√∂ra med <span id="movePersonName" class="fw-bold"></span>?</h5><div class="card p-3 mb-3 border-success bg-light"><label class="form-label fw-bold text-success">Alternativ A: Flytta till vakant bil (Idag)</label><select class="form-select form-select-lg mb-2" name="target_spot" id="moveTargetSpot"><option value="">-- V√§lj i listan --</option></select><button type="submit" name="action" value="move" class="btn btn-success w-100">‚úÖ Bekr√§fta Flytt</button></div><div class="card p-3 border-danger bg-light"><label class="form-label fw-bold text-danger">Alternativ B: Ta bort fr√•n schemat</label><button type="submit" name="action" value="delete" class="btn btn-outline-danger w-100">‚ùå Ta bort fr√•n passet</button></div></div></form></div></div></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    var editModal = new bootstrap.Modal(document.getElementById('editModal'));
    var moveModal = new bootstrap.Modal(document.getElementById('moveModal'));

    $(document).ready(function() {
        $('#selectAmb').select2({
            dropdownParent: $('#editModal'),
            theme: 'bootstrap-5',
            placeholder: "-- V√§lj person --",
            allowClear: true
        });
        $('#selectVub').select2({
            dropdownParent: $('#editModal'),
            theme: 'bootstrap-5',
            placeholder: "-- V√§lj person --",
            allowClear: true
        });

        $('#selectAmb').on('change', checkWarnings);
        $('#selectVub').on('change', checkWarnings);
    });

    document.addEventListener("DOMContentLoaded", function() {
        var collapses = document.querySelectorAll('.station-collapse');
        collapses.forEach(function(el) {
            var storedState = localStorage.getItem(el.id);
            if (storedState === 'closed') { el.classList.remove('show'); }
            el.addEventListener('hidden.bs.collapse', function () { localStorage.setItem(el.id, 'closed'); });
            el.addEventListener('shown.bs.collapse', function () { localStorage.setItem(el.id, 'open'); });
        });
    });

    function openModal(element) {
        var unitId = element.getAttribute('data-unit-id');
        var unitName = element.getAttribute('data-unit-name');
        var period = element.getAttribute('data-period');
        var ambId = element.getAttribute('data-amb');
        var vubId = element.getAttribute('data-vub');
        var comment = element.getAttribute('data-comment'); 
        var personId = element.getAttribute('data-person-id');
        var personName = element.getAttribute('data-person-name');
        var requiresSits = element.getAttribute('data-requires-sits');
        var requiresC1 = element.getAttribute('data-requires-c1'); 
        var interestsRaw = element.getAttribute('data-interests');

        if (unitName.includes("Plats") && personId) {
            document.getElementById('movePersonId').value = personId;
            document.getElementById('movePersonName').innerText = personName;
            var sourceSelect = document.getElementById('vacanciesData');
            var targetSelect = document.getElementById('moveTargetSpot');
            targetSelect.innerHTML = sourceSelect.innerHTML;
            moveModal.show(); return; 
        }

        document.getElementById('modalUnitName').innerText = unitName;
        document.getElementById('modalPeriod').innerText = period;
        document.getElementById('inputUnitId').value = unitId;
        document.getElementById('inputPeriod').value = period;
        document.getElementById('unitRequiresSits').value = requiresSits;
        document.getElementById('unitRequiresC1').value = requiresC1; 
        document.getElementById('inputComment').value = comment;

        $('#selectAmb').val(ambId).trigger('change');
        $('#selectVub').val(vubId).trigger('change');

        var appList = document.getElementById('applicantList');
        var appSection = document.getElementById('applicantSection');
        appList.innerHTML = '';
        if (interestsRaw && interestsRaw.length > 0) {
            appSection.classList.remove('d-none');
            var applicants = interestsRaw.split('|');
            applicants.forEach(function(app) {
                var parts = app.split(':');
                var uId = parts[0]; var uName = parts[1]; var uRole = parts[2];
                var btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                btn.innerHTML = `<span><strong>${uName}</strong> (${uRole})</span> <span class="badge bg-success rounded-pill">V√§lj</span>`;
                btn.onclick = function() {
                    if (uRole === 'AMB' || uRole === 'SSK') { $('#selectAmb').val(uId).trigger('change'); }
                    else { $('#selectVub').val(uId).trigger('change'); }
                };
                appList.appendChild(btn);
            });
        } else { appSection.classList.add('d-none'); }

        if (unitName.includes("Plats")) {
            document.getElementById('vubContainer').style.display = 'none';
            document.getElementById('labelAmb').innerText = "Resurs / Personal";
        } else {
            document.getElementById('vubContainer').style.display = 'block';
            document.getElementById('labelAmb').innerText = "AMB";
        }
        
        setTimeout(checkWarnings, 50);
        editModal.show();
    }

    function checkWarnings() {
        if (document.getElementById('modalUnitName').innerText.includes("Plats")) {
            document.getElementById('c1Warning').classList.add('d-none');
            document.getElementById('sitsWarning').classList.add('d-none');
            document.getElementById('roleWarning').classList.add('d-none');
            return;
        }

        var requiresSits = document.getElementById('unitRequiresSits').value === 'True';
        var requiresC1 = document.getElementById('unitRequiresC1').value === 'True';
        
        var ambId = $('#selectAmb').val();
        var vubId = $('#selectVub').val();
        
        var ambOption = document.querySelector(`#selectAmb option[value='${ambId}']`);
        var vubOption = document.querySelector(`#selectVub option[value='${vubId}']`);

        var showC1Warning = false;
        if (requiresC1 && ambId) {
            var ambHasC1 = ambOption ? ambOption.getAttribute('data-c1') === 'True' : false;
            if (!ambHasC1) showC1Warning = true;
        }
        if (showC1Warning) document.getElementById('c1Warning').classList.remove('d-none');
        else document.getElementById('c1Warning').classList.add('d-none');

        var showRoleWarning = false;
        if (ambId && ambOption && ambOption.getAttribute('data-role') === 'VUB') showRoleWarning = true;
        if (vubId && vubOption && vubOption.getAttribute('data-role') === 'AMB') showRoleWarning = true;
        if (showRoleWarning) document.getElementById('roleWarning').classList.remove('d-none');
        else document.getElementById('roleWarning').classList.add('d-none');

        var showSitsWarning = false;
        if (requiresSits) {
            if (ambId && ambOption && ambOption.getAttribute('data-sits') !== 'True') showSitsWarning = true;
            if (vubId && vubOption && vubOption.getAttribute('data-sits') !== 'True') showSitsWarning = true;
        }
        if (showSitsWarning) document.getElementById('sitsWarning').classList.remove('d-none'); 
        else document.getElementById('sitsWarning').classList.add('d-none');

        checkDoubleBooking();
    }

    function checkDoubleBooking() {
        var warningBox = document.getElementById('doubleBookingWarning');
        var warningText = document.getElementById('doubleBookingText');
        var moveBox = document.getElementById('moveInfo');
        var moveText = document.getElementById('moveInfoText');
        var currentPeriod = document.getElementById('inputPeriod').value; 
        var currentUnitName = document.getElementById('modalUnitName').innerText;
        
        var ambId = $('#selectAmb').val();
        var vubId = $('#selectVub').val();
        var ambOption = document.querySelector(`#selectAmb option[value='${ambId}']`);
        var vubOption = document.querySelector(`#selectVub option[value='${vubId}']`);

        var conflicts = []; var moves = [];

        function checkOption(option) {
            if (option) {
                var busyUnit = option.getAttribute('data-busy-' + currentPeriod.toLowerCase());
                if (busyUnit && busyUnit !== currentUnitName) {
                    if (busyUnit.includes("Plats")) moves.push(option.text.trim().split(' ')[0] + " (fr√•n " + busyUnit + ")");
                    else conflicts.push(option.text.trim().split(' ')[0] + " jobbar redan p√• " + busyUnit);
                }
            }
        }
        if(ambId) checkOption(ambOption); 
        if(vubId) checkOption(vubOption);

        if (conflicts.length > 0) { warningText.innerText = conflicts.join(', '); warningBox.classList.remove('d-none'); } else warningBox.classList.add('d-none');
        if (moves.length > 0) { moveText.innerText = moves.join(', '); moveBox.classList.remove('d-none'); } else moveBox.classList.add('d-none');
    }
</script>

</body>
</html>